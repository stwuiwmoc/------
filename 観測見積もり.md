# 観測理論式

## H3+輝線の放射強度

| 文字                  | 単位                       | 意味                                                     |
| --------------------- | -------------------------- | -------------------------------------------------------- |
| $N(H_3^+)$            | /m$^2$                     | カラム密度                                               |
| $g_{ns}$              | 無次元                     | nuclear spin weight (4 for orth transitions, 2 for para) |
| $J'$                  | 無次元                     | 回転量子数                                               |
| $h$                   | m$^2$ kg / s               | プランク定数                                             |
| $c$                   | m / s                      | 光速                                                     |
| $\omega _{if}$        | /cm                        | 波数                                                     |
| $A_{if}$              | /s                         | アインシュタインのA係数                                  |
| $E'$                  | /cm                        | Energy of the upper level                                |
| $k_B$                 | m$^2$ kg s$^{-2}$ K$^{-1}$ | ボルツマン定数                                           |
| $T_{hypo}$            | K                          | 想定するH3+温度                                          |
| $Q(T)$                | 無次元                     | partition function [ [Miller et al., 2010][] ]           |
| $I_{s}(\omega _{if})$ | W / m$^2$ / str            | 観測対象の放射輝度                                       |
|                       |                            |                                                          |

[Miller et al., 2010]: https://pubs.rsc.org/en/content/articlelanding/2010/FD/c004152c#!divAbstract

$$
I_{obj}(\omega _{if})
=
N(H_3^+) \times
  \cfrac
    {g_{ns} (2J' + 1) hc (\omega _{if} \times 100) A_{if} \times \exp{(- hc \cdot E' \times 100/k_B T_{hypo})}}
    {4 \pi Q(T_{hypo})}
$$

この時、$4\pi$で割っているので単位は /str になる

ここでpartition function $Q(T)$ は、100-1800Kの温度範囲では [Miller et al., 2010][] の式(5)で用いられている以下の値を用いて

| 文字  | 代入値        |
| ----- | ------------- |
| $A_0$ | -1.11391      |
| $A_1$ | +0.0581076    |
| $A_2$ | +0.000302967  |
| $A_3$ | -2.83724e-7   |
| $A_4$ | +2.31119e-10  |
| $A_5$ | -7.15895e-14  |
| $A_6$ | + 1.00150e-17 |
|       |               |

$$
Q(T) = A_0 T^0 + A_1 T^1 + A_2 T^2 + A_3 T^3 + A_4 T^4 + A_5 T^5 + A_6 T^6
$$

を用いればよい

参考
- 坂野井先生資料/資料1_edit中_sakanoi.pptx
- 坂野井先生資料/資料2_1213_edit中_sakanoi.pptx

## 振動温度の導出
$$
T_{vib}
=
\frac{hc}{k_B} \frac{(E'_{HB} - E'_{FD}) \times 100}{\log{\beta} - \log{R}} \\
$$
$$
where
\;\;
\beta = \cfrac{(g_{ns} (2J' + 1)\omega _{if} A_{if})_{HB}}{(g_{ns} (2J' + 1) \omega _{if} A_{if})_{FD}}
\; , \;
R = \frac{I_{HB}}{I_{FD}}
$$


# 誤差検討

## システムゲインの導出

| 文字        | 単位       | 意味                                      | 代入値    | 参照元         |
| ----------- | ---------- | ----------------------------------------- | --------- | -------------- |
| $C_{PD}$    | F          | 検出器フォトダイオードの電気容量          | 7.20e-14  | 神原2020M論p77 |
| $ADU_{ADC}$ | V / DN     | 16bit, +-5V入力のADCでの1DN当たりの電圧値 | 10 / 2^16 |                |
| $G_{SF}$    | 無次元     | 検出器ソースフォロワの倍率                | 0.699     | 神原2020M論p77 |
| $G_{Amp}$   | 無次元     | プリアンプの倍率                          |           |                |
| e           | C / e$^-$  | 素電荷（=電子一つ当たりの電荷）           |           | 物理定数       |
|             |            |                                           |           |                |
| $G_{sys}$   | e$^-$ / DN | システムゲイン                            |           |                |
|             |            |                                           |           |                |


$$
G_{sys}
=
\cfrac{C_{PD}}{e \cdot G_{SF}} \cdot \cfrac{ADU_{ADC}}{G_{Amp}}
$$

## 装置透過率の導出

| 文字                 | 単位   | 意味                               | 代入値 | 参照元                               |
| -------------------- | ------ | ---------------------------------- | ------ | ------------------------------------ |
| $\tau _t$            | 無次元 | 望遠鏡の透過率                     | 0.66   | 宇野2009M論p98                       |
|                      |        |                                    |        |                                      |
| $\tau _f$            | 無次元 | 分光器導入用ファイバーの透過率     |        |                                      |
| $\tau _{f.coupling}$ | 無次元 | ファイバー接続部分での結合損失     | 0.5    | 明確なソース無し、仮の値として設定   |
| $\tau _{f.unit}$     | /m     | ファイバーの単位長さ当たりの透過率 | 0.98   | [THORLABS webpage][]                 |
| $l_f$                | m      | ファイバーの長さ                   |        |                                      |
|                      |        |                                    |        |                                      |
| $\tau _s$            | 無次元 | ESPRITの透過率                     |        |                                      |
| $\tau _{s.lens}$     | 無次元 | 内部光学系のレンズの透過率         | 0.66   | 宇野2009M論p98                       |
| $\tau _{s.mirror}$   | 無次元 | 内部光学系の鏡の透過率             | 0.86   | 宇野2009M論p98                       |
| $\tau _{s.grating}$  | 無次元 | エシェルの回折効率                 | 0.66   | 宇野2009M論p98、仮に固定値として設定 |
|                      |        |                                    |        |                                      |
| $\tau _e$            | 無次元 | 装置の光学系全体の透過率の合算     |        |                                      |
|                      |        |                                    |        |                                      |

[THORLABS webpage]:https://www.thorlabs.co.jp/newgrouppage9.cfm?objectgroup_id=7062#ad-image-0

ここで、分光器導入用ファイバーの透過率は
$$
\tau_f = \tau _{f.coupling} \cdot (\tau _{f.unit})^{l_f}
$$

また、ESPRIT内の装置透過率は
$$
\tau_s = \tau _{s.lens} \cdot \tau _{s.mirror} \cdot \tau _{s.grating}
$$
ここで、$\tau _{s.grating}$ は実際は波長依存性がかなりある（宇野2012D論p106）が、ひとまず固定値として計算している

これらを用いて、装置全体での透過率は
$$
\tau _e = \tau_t \cdot \tau_f \cdot \tau _s
$$

## 装置のpixel数関連の導出

| 文字        | 単位         | 意味                   | 代入値 | 参照元                                 |
| ----------- | ------------ | ---------------------- | ------ | -------------------------------------- |
| $s_{plate}$ | arcsec / pix | プレートスケール       | 0.3    | 宇野2012D論p95、但しESPRIT光学系での値 |
| $w_{slit}$  | arcsec       | ESPRITの分光スリット幅 | 0.7    | 神原2020M論p83                         |
|             |              |                        |        |                                        |
| $\Omega$    | str / pix    | 1pixelが見込む立体角   |        |                                        |
| $n_{pix}$   | pix          | 輝線の検出器上での幅   |        |                                        |
|             |              |                        |        |                                        |

但しここで、プレートスケールは検出器までの光学系に依存するため、TOPICSでは値が変わることに注意
（高橋2005M論p43, p44を参照）

$$
\Omega = 2.35 \times 10^{-11} \cdot s_{plate}
$$
$$
n_{pix} = w_{slit} / s_{plate}
$$

## 観測によるSignalの導出

単位時間当たりの、観測対象の放射輝度と検出器に蓄積される1秒当たりの電子数の関係を考える

| 文字             | 単位            | 意味                                           | 代入値 | 参照元         |
| ---------------- | --------------- | ---------------------------------------------- | ------ | -------------- |
| $I_{obj}$        | W / m$^2$ / str | 対象の放射輝度（W=J/sなので1秒当たりの量）     |        | 導出済         |
| $A_t$            | m$^2$           | 望遠鏡の開口面積                               |        |                |
| $\eta$           | e$^-$ / photon  | 量子効率（一つの光子を何個の電子に変換するか） | 0.889  | 神原2020M論p24 |
| $\Omega$         | str / pix       | 観測立体角                                     |        | 導出済         |
| $G_{sys}$        | e$^-$ / DN      | システムゲイン                                 |        | 導出済         |
| $\tau _{\alpha}$ | 無次元          | 大気の透過率                                   | 0.9    | [岩室2009][]   |
| $\tau _e$        | 無次元          | 装置の光学系全体の透過率の合算                 |        | 導出済         |
| $\lambda$        | m               | 観測対象の波長                                 |        |                |
| $c$              | m / s           | 光速                                           |        | 物理定数       |
| $t_{obs}$        | s               | 積分時間                                       |        |                |
| $n_{pix}$        | pix             | 輝線が広がる幅                                 |        | 導出済         |
|                  |                 |                                                |        |                |
| $S_{obj}$        | DN              | $t_{obs}$ 秒間に検出器に蓄積されるカウント値   |        |                |
|                  |                 |                                                |        |                |

[岩室2009]: http://www.kusastro.kyoto-u.ac.jp/~iwamuro/LECTURE/OBS/atmos.html

$$
S_{obj}
=
\frac
  {(I_{obj} \cdot A_t \cdot \Omega \cdot \tau_\alpha \cdot \tau _e)}
  { \left(h \cdot c / \lambda \right)}
 \cdot \eta \cdot \cfrac{1}{G_{sys}} \cdot t_{obs} \cdot n_{pix}
$$
ここで、$(I_{obj} \cdot A_t \cdot \Omega) \cdot \tau_\alpha \cdot \tau _e$ は観測対象から望遠鏡の口径内に到達するエネルギーを示し、 $(h \cdot c / \lambda)$ はエネルギーを光子数に変換している。

## その他のSignalの導出と、 $S_{all}$ の導入
| 文字       | 単位            | 意味                                                    |
| ---------- | --------------- | ------------------------------------------------------- |
| $I_{dark}$ | e$^-$ / s / pix | 検出器の暗電流（リーク電流）                            |
| $I_{GBT}$  | W / m$^2$ / str | 1秒あたりの望遠鏡（鏡面など）からの熱輻射（赤外発光）   |
| $I_{sky}$  | W / m$^2$ / str | 1秒あたりの地球大気の赤外輻射                           |
|            |                 |                                                         |
| $S_{dark}$ | DN              | 検出器の暗電流によるカウント値                          |
| $S_{GBT}$  | DN              | 望遠鏡からの熱輻射によるカウント値                      |
| $S_{sky}$  | DN              | 地球大気の赤外輻射によるカウント値                      |
|            |                 |                                                         |
| $S_{all}$  | DN              | ある露光時間 $t_{obs}$ での赤外輻射成分全体のカウント値 |
|            |                 |                                                         |

検出器の暗電流 $I_{dark}$ [e$^-$/s] は検出器から発生するものなので、

$$
S_{dark} = \frac{I_{dark}}{G_{sys}} \cdot t_{obs} \cdot n_{pix}
$$

のみの議論で良い。

$I_{GBT}$ と $I_{sky}$ は $I_{obj}$ と同様に考えて

$$
S_{GBT}
=
\frac
  {(I_{GBT} \cdot A_t \cdot \Omega \cdot \tau_t)}
  { \left(h \cdot c / \lambda \right)}
 \cdot \eta \cdot \cfrac{1}{G_{sys}} \cdot t_{obs} \cdot n_{pix}
$$

$$
S_{sky}
=
\frac
  {(I_{sky} \cdot A_t \cdot \Omega \cdot \tau_t)}
  { \left(h \cdot c / \lambda \right)}
 \cdot \eta \cdot \cfrac{1}{G_{sys}} \cdot t_{obs} \cdot n_{pix}
$$

となる。このとき、$S_{obj}$ と異なり $\tau_{\alpha}$ をかけていないことに注意する。
（$I_{GBT}$ は望遠鏡の発光なので大気を通過していない。$I_{GBT}$ には大気透過率の議論がすでに含まれている。）

実際の $I_{GBT}$ と $I_{GBT}$ の値は 野口M論p9に以下のような記載があるが、ソースが明確に書かれていない。
（恐らく [岩室2009] を参考にしているので、リンク先の記述を見る限りだと $I_{sky}$ には大気透過率 $\tau_{\alpha}$ の議論が含まれていると思われる）

| 条件                                       | 波長   | $I_{GBT} + I_{GBT}$ の値 [ W / m$^2$ / str ] |
| ------------------------------------------ | ------ | -------------------------------------------- |
| フィルター分光（TOPICS）16 nm              | 3.4 um | $3.98 \times 10^{-4}$                        |
| スリット分光（ESPRIT）0.17 nm              | 3.4 um | $2.99 \times 10^{-6}$                        |
| スリット分光（ESPRIT）0.12 nm + 太陽散乱光 | 2.0 um | $4.83 \times 10^{-9} + 1.07 \times 10^{-6}$  |
|                                            |        |                                              |

以上より、検出器にある積分時間の間に入射する赤外輻射成分のカウント値の総和は

$$
S_{all} = S_{obj} + S_{sky} + S_{GBT} + S_{dark}
$$

である。このうち、$S_{obj}$ 以外はノイズとなるが、ダーク画像、スカイ画像によって取り除くことができるため、この後のS/Nの計算では $S_{obj}$ のみを考えればよい

## Noise導出

| 文字            | Signalとの関係     | 単位              | 意味                                  |
| --------------- | ------------------ | ----------------- | ------------------------------------- |
| $N_{obj.shot}$  | $=\sqrt{S_{obj}}$  | DN$_{rms}$        | $S_{obj}$ の統計的揺らぎのカウント値  |
| $N_{GBT.shot}$  | $=\sqrt{S_{GBT}}$  | DN$_{rms}$        | $S_{GBT}$ の統計的揺らぎのカウント値  |
| $N_{sky.shot}$  | $=\sqrt{S_{sky}}$  | DN$_{rms}$        | $S_{sky}$ の統計的揺らぎのカウント値  |
| $N_{dark.shot}$ | $=\sqrt{S_{dark}}$ | DN$_{rms}$        | $S_{dark}$ の統計的揺らぎのカウント値 |
| $N_{read}$      |                    | e$^-_{rms}$ / pix | 読み出しノイズ（時間依存しない）      |
|                 |                    |                   |                                       |
| $N_{FPA}$       |                    | DN$_{rms}$        | 検出器の全ノイズ成分                  |
| $N_{all}$       |                    | DN$_{rms}$        | 全ノイズ成分                          |
|                 |                    |                   |                                       |

これらのノイズ成分は平均値からのばらつき成分であり、お互いに相関の無い複数のノイズが重畳する場合の全体のノイズは、エネルギー的に加算されるため、二乗加算平方根として求められる。

よって、検出器のノイズは、
$$
N_{FPA} = \sqrt{(N_{dark.shot}) ^2 + (N_{read} / G_{sys})^2 \cdot n_{pix}}
$$

全ノイズ成分は、
$$
N_{all}
=
\sqrt{
  (N_{obj.shot})^2
  + (N_{sky.shot})^2
  + (N_{GBT.shot})^2
  + (N_{dark.shot})^2
  + (N_{read} / G_{sys})^2 \cdot n_{pix}
  }
$$

## S/N導出と $\Delta S$ の導入
| 文字             | 単位   | 意味             |
| ---------------- | ------ | ---------------- |
| $SNR$            | 無次元 | S/N比            |
| $\Delta S_{obj}$ | DN     | $S_{obj}$ の誤差 |
|                  |        |                  |

以上より

$$
SNR
=
\frac{S_{obj}}{N_{all}}
=
\cfrac{S_{obj}}{\sqrt{S_{obj} + S_{sky} + S_{GBT} + S_{dark}+ (N_{read} / G_{sys})^2 \cdot n_{pix}}}
$$

となる。ここから、観測対象の真の値 $S_{obj}$ に対する誤差 $\Delta S_{obj}$ を求めるには
$$
\Delta S_{obj} = S_{obj} / SNR
$$
とすればよい。

# 観測誤差の伝搬
## 輝線強度比 $R$ の誤差伝搬
| 文字     | 単位   | 意味                             |
| -------- | ------ | -------------------------------- |
| $R$      | 無次元 | HBとFDの輝線強度比               |
| $S_{FD}$ | DN     | Fundamental bandの観測カウント値 |
| $S_{HB}$ | DN     | Hot bandの観測カウント値         |
|          |        |                                  |
| $R_S$    | 無次元 | HBとFDの観測カウント値の比       |
|          |        |                                  |


温度の導出は[上記](#振動温度の導出)の通り。実際の温度導出では観測値 [DN] 同士の比を使うため
$$
R = \frac{I_{HB}}{I_{FD}}
$$

ではなく

$$
R_S = \frac{S_{HB}}{S_{FD}}
$$

を用いて

$$
T
=
\frac{hc}{k} \frac{E'_{HB} - E'_{FD}}{\log{\beta} - \log{R_S}}
$$

である。この時、$S_{FD}$ と $S_{HB}$ にはそれぞれ観測誤差が乗るため、$R_S$ への誤差伝搬は[このリンク](http://www.tagen.tohoku.ac.jp/labo/ishijima/gosa-03.html)を参考に計算すると

$$
R_S \pm \Delta R_S
=
\frac{S_{HB} \pm \Delta S_{HB}}{S_{FD} \pm \Delta S_{FD}}
=
\frac{S_{HB}}{S_{FD}} \pm
  \sqrt{
    \left( \cfrac{1}{S_{FD}} \cdot \Delta S_{HB} \right)^2
    +
    \left( \cfrac{S_{HB}}{S_{FD}^2} \cdot \Delta S_{FD} \right)^2
    }
$$
よって
$$
\Delta R_S
=
\sqrt{
  \left( \cfrac{1}{S_{FD}} \Delta S_{HB} \right)^2
  +
  \left( \cfrac{S_{HB}}{S_{FD}^2} \Delta S_{FD} \right)^2
  }
$$
である。

## 温度Tへの誤差伝搬
温度 $T$ は $R_S$ の関数になっているため、

$$
\Delta T
=
\frac{\partial T}{\partial R_S} \Delta R_S
=
\left(- \frac{hc}{k} \frac{E'_{HB} - E'_{FD}}{\{\log{\beta} - \log{R_S}\}^2} \cdot \frac{1}{R_S} \right)
  \Delta R_S
$$

である。以上で温度決定誤差 $\Delta T$ を計算できる。